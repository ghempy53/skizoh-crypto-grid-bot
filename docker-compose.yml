# =============================================================================
# Skizoh Grid Bot v2.0 - Docker Compose Configuration
# Optimized for Raspberry Pi deployment
# =============================================================================
#
# Usage:
#   docker compose up -d        # Start bot
#   docker compose logs -f      # View logs
#   docker compose down         # Stop bot
#   docker compose restart      # Restart bot
#
# =============================================================================

services:
  gridbot:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    
    image: skizoh-grid-bot:2.0
    container_name: skizoh-gridbot
    
    restart: unless-stopped
    
    environment:
      - TZ=${TZ:-America/Denver}
      - PYTHONUNBUFFERED=1
      - OMP_NUM_THREADS=1
      - OPENBLAS_NUM_THREADS=1
      - MKL_NUM_THREADS=1
      - GRIDBOT_SCENARIO=${GRIDBOT_SCENARIO:-}
      - GRIDBOT_NONINTERACTIVE=${GRIDBOT_NONINTERACTIVE:-false}
    
    volumes:
      # Config file (read-only)
      - ./config.json:/app/src/priv/config.json:ro
      # Data persistence
      - ./data:/app/data
    
    tmpfs:
      - /tmp:size=32m,mode=1777
      - /app/.cache:size=16m,mode=755,uid=1000,gid=1000
    
    # Resource limits - adjust for your Pi model
    # Pi 3: memory: 256M, cpus: 0.5
    # Pi 4 (2GB): memory: 384M, cpus: 0.75
    # Pi 4 (4GB+): memory: 512M, cpus: 1.0
    # Pi 5: memory: 768M, cpus: 1.5
    deploy:
      resources:
        limits:
          cpus: '0.75'
          memory: 384M
        reservations:
          cpus: '0.25'
          memory: 128M
    
    mem_swappiness: 10
    memswap_limit: 768M
    oom_kill_disable: false
    oom_score_adj: 500
    
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
        compress: "true"
    
    dns:
      - 8.8.8.8
      - 1.1.1.1
    
    networks:
      - gridbot-net
    
    healthcheck:
      test: ["CMD", "python3", "-c", "import ccxt; import numpy; print('ok')"]
      interval: 120s
      timeout: 15s
      retries: 3
      start_period: 60s
    
    security_opt:
      - no-new-privileges:true
    
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

networks:
  gridbot-net:
    driver: bridge
